{% extends 'base.html' %}
{% load form_tags %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/customstyle.css' %}">
<!-- Compact Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="custom-breadcrumb mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'dashboard' %}" class="text-decoration-none">
                <i class="mdi mdi-home-outline mdi-18px"></i> Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'member_list' %}" class="text-decoration-none">
                <i class="mdi mdi-account-multiple-outline mdi-18px"></i> Members
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="mdi mdi-account-plus-outline mdi-18px"></i> Add Member
        </li>
    </ol>
</nav>

<div class="container">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Add New Member</h4>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <fieldset class="border p-4 rounded mb-4">
                    <legend class="w-auto px-2 h5">Personal Info</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="id_first_name" class="form-label">First Name</label>
                            {{ form.first_name|attr:"required:true" }}
                            {% for error in form.first_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a first name.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_last_name" class="form-label">Last Name</label>
                            {{ form.last_name|attr:"required:true" }}
                            {% for error in form.last_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a last name.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_gender" class="form-label">Gender</label>
                            {{ form.gender|attr:"required:true" }}
                            {% for error in form.gender.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please select a gender.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_date_of_birth" class="form-label">Date of Birth</label>
                            {{ form.date_of_birth|attr:"required:true" }}
                            {% for error in form.date_of_birth.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a date of birth.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_age" class="form-label">Age</label>
                            {{ form.age|attr:"required:true" }}
                            {% for error in form.age.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter an age.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_profession" class="form-label">Profession</label>
                            {{ form.profession|attr:"required:true" }}
                            {% for error in form.profession.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a profession.
                            </div>
                        </div>
                       
                    </div>
                </fieldset>

                <fieldset class="border p-4 rounded mb-4">
                    <legend class="w-auto px-2 h5">Contact Details</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="id_mobile_number" class="form-label">Mobile Number</label>
                            {{ form.mobile_number|attr:"required:true" }}
                            {% for error in form.mobile_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a mobile number.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_email" class="form-label">Email</label>
                            {{ form.email|attr:"required:true" }}
                            {% for error in form.email.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a valid email address.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_pincode" class="form-label">Pincode</label>
                            {{ form.pincode|attr:"required:true" }}
                            {% for error in form.pincode.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a pincode.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_address" class="form-label">Address</label>
                            {{ form.address|attr:"required:true" }}
                            {% for error in form.address.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter an address.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_area" class="form-label">Area</label>
                            {{ form.area|attr:"required:true" }}
                            {% for error in form.area.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter an area.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_city" class="form-label">City</label>
                            {{ form.city|attr:"required:true" }}
                            {% for error in form.city.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a city.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_state" class="form-label">State</label>
                            {{ form.state|attr:"required:true" }}
                            {% for error in form.state.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter a state.
                            </div>
                        </div>
                        
                    </div>
                </fieldset>

                <fieldset class="border p-4 rounded mb-4">
                    <legend class="w-auto px-2 h5">Documents</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="id_profile_picture" class="form-label">Profile Picture</label>
                            {{ form.profile_picture }}
                            {% for error in form.profile_picture.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please upload a profile picture.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_sign" class="form-label">Signature</label>
                            {{ form.sign }}
                            {% for error in form.sign.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please upload a signature.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_identity_type" class="form-label">Identity Type</label>
                            {{ form.identity_type }}
                            {% for error in form.identity_type.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please select an identity type.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_identity_no" class="form-label">Identity Number</label>
                            {{ form.identity_no }}
                            {% for error in form.identity_no.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please enter an identity number.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_identity_document_image" class="form-label">Identity Document</label>
                            {{ form.identity_document_image }}
                            {% for error in form.identity_document_image.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                            <div class="invalid-feedback">
                                Please upload an identity document.
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border p-4 rounded mb-4">
                    <legend class="w-auto px-2 h5">Medical History</legend>
                    {{ medical_formset.management_form }}
                    <div id="medical-formset-container">
                        {% for form in medical_formset %}
                            <div class="row medical-formset-row">
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.condition.id_for_label }}" class="form-label">Condition</label>
                                    {{ form.condition }}
                                    <div class="invalid-feedback">
                                        Please enter a condition.
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.type.id_for_label }}" class="form-label">Type</label>
                                    {{ form.type }}
                                    <div class="invalid-feedback">
                                        Please enter a type.
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.since.id_for_label }}" class="form-label">Since</label>
                                    {{ form.since }}
                                    <div class="invalid-feedback">
                                        Please enter a date.
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger remove-medical-formset-row">Remove</button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" id="add-medical-formset-row" class="btn btn-success">Add More</button>
                </fieldset>

                <fieldset class="border p-4 rounded mb-4">
                    <legend class="w-auto px-2 h5">Emergency Contact</legend>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ emergency_form.name.id_for_label }}" class="form-label">Name</label>
                            {{ emergency_form.name|attr:"required:true" }}
                            <div class="invalid-feedback">
                                Please enter an emergency contact name.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ emergency_form.mobile.id_for_label }}" class="form-label">Mobile</label>
                            {{ emergency_form.mobile|attr:"required:true" }}
                            <div class="invalid-feedback">
                                Please enter an emergency contact mobile number.
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ emergency_form.relation.id_for_label }}" class="form-label">Relation</label>
                            {{ emergency_form.relation|attr:"required:true" }}
                            <div class="invalid-feedback">
                                Please enter the emergency contact's relation.
                            </div>
                        </div>
                    </div>
                </fieldset>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary me-2">Submit</button>
                    <a href="{% url 'member_list' %}" class="btn btn-light">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('medical-formset-container');
    const addButton = document.getElementById('add-medical-formset-row');
    const totalForms = document.querySelector('input[name="{{ medical_formset.prefix }}-TOTAL_FORMS"]');
    const emptyFormTemplate = `
        <div class="row medical-formset-row">
            <div class="col-md-3 mb-3">
                <label for="id_{{ medical_formset.prefix }}-__prefix__-condition" class="form-label">Condition</label>
                {{ medical_formset.empty_form.condition }}
            </div>
            <div class="col-md-3 mb-3">
                <label for="id_{{ medical_formset.prefix }}-__prefix__-type" class="form-label">Type</label>
                {{ medical_formset.empty_form.type }}
            </div>
            <div class="col-md-3 mb-3">
                <label for="id_{{ medical_formset.prefix }}-__prefix__-since" class="form-label">Since</label>
                {{ medical_formset.empty_form.since }}
            </div>
            <div class="col-md-3 mb-3 d-flex align-items-end">
                <button type="button" class="btn btn-danger remove-medical-formset-row">Remove</button>
            </div>
        </div>
    `;

    addButton.addEventListener('click', function () {
        let newIndex = parseInt(totalForms.value);
        let newForm = emptyFormTemplate.replace(/__prefix__/g, newIndex);
        container.insertAdjacentHTML('beforeend', newForm);
        totalForms.value = newIndex + 1;
    });

    container.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('remove-medical-formset-row')) {
            const row = e.target.closest('.medical-formset-row');
            const deleteInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (deleteInput) {
                deleteInput.checked = true;
                row.style.display = 'none';
            } else {
                row.remove();
                updateFormIndexes();
            }
        }
    });

    function updateFormIndexes() {
        const rows = container.querySelectorAll('.medical-formset-row');
        let formCount = 0;
        rows.forEach((row, index) => {
            if (row.style.display !== 'none') {
                formCount++;
                row.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.name) {
                        const name = input.name.replace(/-(\d+|__prefix__)-/, `-${index}-`);
                        const id = input.id.replace(/-(\d+|__prefix__)-/, `-${index}-`);
                        input.name = name;
                        input.id = id;
                        const label = document.querySelector(`label[for="${id.replace(index, '__prefix__')}"]`);
                        if (label) {
                            label.setAttribute('for', id);
                        }
                    }
                });
            }
        });
        totalForms.value = formCount;
    }
});
</script>
{% endblock %}