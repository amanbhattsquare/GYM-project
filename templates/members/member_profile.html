{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Compact Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="custom-breadcrumb mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'dashboard' %}" class="text-decoration-none">
                <i class="mdi mdi-home-outline mdi-18px"></i> Dashboard
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'member_list' %}" class="text-decoration-none">
                <i class="mdi mdi-account-multiple-outline mdi-18px"></i> Members List
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="mdi mdi-account-multiple-outline mdi-18px"></i> Member Profile
        </li>
    </ol>
</nav>  
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0 justify-content-start">Member Profile</h2>
                 <div class="d-flex justify-content-end">
                                <a href="{% url 'edit_member' member.id %}" class="btn btn-sm btn-secondary mr-2">Edit</a>
                                <a href="{% url 'assign_membership_plan' member.id %}" class="btn btn-success mr-2">Assign Plan</a>      
                                <a href="{% url 'assign_pt_trainer' member.id %}" class="btn btn-danger mr-2">Assign Personal Trainer</a>      
                            </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="border-bottom text-center pb-4">
                            {% if member.profile_picture %}
                                <img src="{{ member.profile_picture.url }}" alt="profile" class="img-lg rounded-circle mb-3"/>
                            {% else %}
                                <img src="{% static 'images/gym-guy.jpg' %}" alt="profile" class="img-lg rounded-circle mb-3"/>
                            {% endif %}
                            <h4>{{ member.first_name }} {{ member.last_name }}</h4>
                            {% if due_amount > 0 %}
                            <h5 class="text-danger">Due: ₹{{ due_amount }}</h5>
                            {% endif %}
                           
                        </div>
                        <div class="py-4">
                            <p class="clearfix">
                                <span class="float-left">Status</span>
                                <span class="float-right text-muted">
                                    {% if member.status == 'active' %}
                                        <span class="badge badge-success">Active</span>
                                    {% else %}
                                        <span class="badge badge-danger">Inactive</span>
                                    {% endif %}
                                </span>
                            </p>
                            <p class="clearfix">
                                <span class="float-left">Phone</span>
                                <span class="float-right text-muted">{{ member.mobile_number }}</span>
                            </p>
                            <p class="clearfix">
                                <span class="float-left">Mail</span>
                                <span class="float-right text-muted">{{ member.email }}</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="mt-4 py-2">
                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="personal-tab" data-toggle="tab" href="#personal" role="tab" aria-controls="personal" aria-selected="true">Personal Details</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="documents-tab" data-toggle="tab" href="#documents" role="tab" aria-controls="documents" aria-selected="false">Documents</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="medical-tab" data-toggle="tab" href="#medical" role="tab" aria-controls="medical" aria-selected="false">Medical History</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="emergency-tab" data-toggle="tab" href="#emergency" role="tab" aria-controls="emergency" aria-selected="false">Emergency Contact</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="plan-tab" data-toggle="tab" href="#plan" role="tab" aria-controls="plan" aria-selected="false">Membership Plan</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="invoices-tab" data-toggle="tab" href="#invoices" role="tab" aria-controls="invoices" aria-selected="false">Invoice History</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="personal-trainer-tab" data-toggle="tab" href="#personal-trainer" role="tab" aria-controls="personal-trainer" aria-selected="false">Personal Trainer Info</a>
                                </li>
                            </ul>
                            <div class="tab-content" id="myTabContent">
                                  <div class="tab-pane fade" id="personal-trainer" role="tabpanel" aria-labelledby="personal-trainer-tab">
                                      <div class="table-responsive">
                                          <table class="table table-bordered">
                                              <thead>
                                                  <tr>
                                                      <th>Trainer Name</th>
                                                      <th>Start Date</th>
                                                      <th>End Date</th>
                                                      <th>Total Amount</th>
                                                      <th>Paid Amount</th>
                                                  </tr>
                                              </thead>
                                              <tbody>
                                                  {% for pt in pt_member %}
                                                  <tr>
                                                      <td>{{ pt.trainer.name }}</td>
                                                      <td>{{ pt.pt_start_date|date:"d-m-Y" }}</td>
                                                      <td>{{ pt.get_end_date|date:"d-m-Y" }}</td>
                                                      <td>{{ pt.total_amount }}</td>
                                                      <td>{{ pt.paid_amount }}</td>
                                                  </tr>
                                                  {% empty %}
                                                  <tr>
                                                      <td colspan="5" class="text-center">This member has not been assigned a personal trainer.</td>
                                                  </tr>
                                                  {% endfor %}
                                              </tbody>
                                          </table>
                                      </div>
                                  </div>
                                <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
                                    <div class="py-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Age:</strong> {{ member.age }}</p>
                                                <p><strong>Gender:</strong> {{ member.gender }}</p>
                                                <p><strong>Date of Birth:</strong> {{ member.date_of_birth }}</p>
                                                <p><strong>Profession:</strong> {{ member.profession }}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group row">
                                                    <label class="col-sm-3 col-form-label">Address</label>
                                                    <div class="col-sm-9">
                                                        <p class="form-control-static">{{ member.address }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                                    <div class="py-3">
                                        <div class="row">
                                            <div class="col-md-4 text-center">
                                                <h5>Signature</h5>
                                                {% if member.sign %}
                                                    <img src="{{ member.sign.url }}" alt="Signature" class="img-fluid">
                                                {% else %}
                                                    <p class="text-muted">Not Provided</p>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <h5>Identity Document</h5>
                                                {% if member.identity_document_image %}
                                                    <img src="{{ member.identity_document_image.url }}" alt="Identity Document" class="img-fluid">
                                                {% else %}
                                                    <p class="text-muted">Not Provided</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="medical" role="tabpanel" aria-labelledby="medical-tab">
                                    <div class="py-3">
                                        {% if member.medical_history.all %}
                                            <ul class="list-group">
                                                {% for history in member.medical_history.all %}
                                                    <li class="list-group-item">
                                                        <strong>{{ history.condition }}</strong> ({{ history.type }}) - Since: {{ history.since }}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted">No medical history provided.</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="emergency" role="tabpanel" aria-labelledby="emergency-tab">
                                    <div class="py-3">
                                        {% if member.emergency_contact %}
                                            <p><strong>Name:</strong> {{ member.emergency_contact.name }}</p>
                                            <p><strong>Mobile:</strong> {{ member.emergency_contact.mobile }}</p>
                                            <p><strong>Relation:</strong> {{ member.emergency_contact.relation }}</p>
                                        {% else %}
                                            <p class="text-muted">No emergency contact provided.</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="plan" role="tabpanel" aria-labelledby="plan-tab">
                                    <div class="py-3">
                                        {% if membership_history %}
                                            <h4>Current Membership Plan</h4>
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">{{ membership_plan.title }}</h5>
                                                    <p class="card-text">{{ membership_plan.description }}</p>
                                                    <ul class="list-group list-group-flush">
                                                        <li class="list-group-item"><strong>Duration:</strong> {{ membership_plan.get_duration_display }}</li>
                                                        <li class="list-group-item"><strong>Price:</strong> ₹{{ membership_plan.price }}</li>
                                                    </ul>
                                                    <p class="card-text">
                                                        <strong>Price:</strong> {{ membership_history.plan.price }} <br>
                                                        <strong>Duration:</strong> {{ membership_history.plan.get_duration_display }} <br>
                                                        <strong>Start Date:</strong> {{ membership_history.membership_start_date|date:"d-m-Y" }} <br>
                                                        <strong>End Date:</strong> {{ membership_history.get_end_date|date:"d-m-Y" }}
                                                    </p>
                                                </div>
                                            </div>
                                            <hr>
                                        {% else %}
                                            <p class="text-muted">No active membership plan.</p>
                                        {% endif %}

                                        <h4>Plan History</h4>
                                        {% if membership_histories %}
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Plan</th>
                                                            <th>Start Date</th>
                                                            <th>End Date</th>
                                                            <th>Price</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for history in membership_histories %}
                                                            <tr>
                                                                <td>{{ history.plan.title }}</td>
                                                                <td>{{ history.membership_start_date|date:"d-m-Y" }}</td>
                                                                <td>{{ history.get_end_date|date:"d-m-Y" }}</td>
                                                                <td>{{ history.plan.price }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <p class="text-muted">No plan history found.</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="invoices" role="tabpanel" aria-labelledby="invoices-tab">
                                    <div class="py-3">
                                        <h4 class="mt-3">Membership Invoices</h4>
                                        {% if membership_histories %}
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Plan</th>
                                                            <th>Start Date</th>
                                                            <th>End Date</th>
                                                            <th>Total</th>
                                                            <th>Paid</th>
                                                            <th>Due</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for history in membership_histories %}
                                                            <tr>
                                                                <td>{{ history.plan.title }}</td>
                                                                <td>{{ history.membership_start_date|date:"d-m-Y" }}</td>
                                                                <td>{{ history.get_end_date|date:"d-m-Y" }}</td>
                                                                <td>₹{{ history.total_amount }}</td>
                                                                <td>₹{{ history.paid_amount }}</td>
                                                                <td>₹{{ history.due_amount }}</td>
                                                                <td>
                                                                    <a href="{% url 'billing:invoice' member.id history.id %}" class="btn btn-primary btn-sm">View Invoice</a>
                                                                </td>
                                                            </tr>
                                                        {% empty %}
                                                            <tr>
                                                                <td colspan="7" class="text-center">No membership invoices found.</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <p class="text-muted">No membership invoice history found.</p>
                                        {% endif %}

                                        <hr>

                                        <h4 class="mt-3">Personal Training Invoices</h4>
                                        {% if pt_invoices %}
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Invoice ID</th>
                                                            <th>Trainer</th>
                                                            <th>Start Date</th>
                                                            <th>End Date</th>
                                                            <th>Total</th>
                                                            <th>Due</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for pt_invoice in pt_invoices %}
                                                            <tr>
                                                                <td><a href="{% url 'billing:pt_invoice' member.id pt_invoice.id %}">#{{ pt_invoice.id }}</a></td>
                                                                <td>{{ pt_invoice.trainer.name }}</td>
                                                                <td>{{ pt_invoice.pt_start_date|date:"d M, Y" }}</td>
                                                                <td>{{ pt_invoice.get_end_date|date:"d-m-Y" }}</td>
                                                                <td>₹{{ pt_invoice.total_amount }}</td>
                                                                <td>₹{{ pt_invoice.due_amount }}</td>
                                                                <td>
                                                                    <a href="{% url 'billing:pt_invoice' member.id pt_invoice.id %}" class="btn btn-sm btn-primary">View Invoice</a>
                                                                </td>
                                                            </tr>
                                                        {% empty %}
                                                            <tr>
                                                                <td colspan="7" class="text-center">No personal training invoices found.</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <p class="text-muted">No personal training invoices found.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}