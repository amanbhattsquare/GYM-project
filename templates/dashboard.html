<!-- Enhanced Gym Dashboard HTML Template - Industry Ready, Modern, Premium UI -->
{% extends "base.html" %}
{% load static humanize %}
{% block content %}
<div class="col-lg-12 px-0">
    <div class="content-wrapper py-4">

        <!-- HEADER -->
        <div class="page-header d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-0 font-weight-bold">Dashboard Overview</h3>
                <small class="text-muted">Your complete gym management analytics</small>
            </div>
        </div>

        <!-- TOP METRICS -->
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow-sm bg-primary-soft ">
                    <div class="card-body">
                        <p class="mb-1">Total Members</p>
                        <h3>{{ total_members|intcomma }}</h3>
                        <small>Updated today</small>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow-sm bg-success-soft ">
                    <div class="card-body">
                        <p class="mb-1">Active Members</p>
                        <h3>{{ active_members|intcomma }}</h3>
                        <small>Active today</small>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow-sm bg-danger-soft ">
                    <div class="card-body">
                        <p class="mb-1">Expired Members</p>
                        <h3>{{ inactive_members|intcomma }}</h3>
                        <small>Expired in last 30 days</small>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow-sm bg-warning-soft  ">
                    <div class="card-body">
                        <p class="mb-1">New (30 Days)</p>
                        <h3>{{ new_members_last_30_days|intcomma }}</h3>
                        <small>New registrations</small>
                    </div>
                </div>
            </div>
        </div>


        <!-- QUICK ACTION CARDS -->
        <div class="quick-actions-container">
            <h4 class="section-title">Quick Actions</h4>
            <div class="row row-cols-2 row-cols-sm-4 row-cols-lg-8 g-3">
                <div class="col">
                    <a href="{% url 'add_new_member' %}" class="quick-action-card">
                        <div class="icon-wrapper bg-primary-soft">
                            <i class="fas fa-user-plus text-primary"></i>
                        </div>
                        <span>Add Member</span>
                    </a>
                </div>
                <div class="col">
                    <a href="{% url 'add_new_enquiry' %}" class="quick-action-card">
                        <div class="icon-wrapper bg-info-soft">
                            <i class="fas fa-comment-alt text-info"></i>
                        </div>
                        <span>New Enquiry</span>
                    </a>
                </div>
                <div class="col">
                    <a href="{% url 'billing:submit_due' %}" class="quick-action-card">
                        <div class="icon-wrapper bg-success-soft">
                            <i class="fas fa-money-bill-wave text-success"></i>
                        </div>
                        <span>Make Payment</span>
                    </a>
                </div>
                <div class="col">
                    <a href="{% url 'expense_add' %}" class="quick-action-card">
                        <div class="icon-wrapper bg-danger-soft">
                            <i class="fas fa-file-invoice-dollar text-danger"></i>
                        </div>
                        <span>Add Expense</span>
                    </a>
                </div>
                
                <div class="col">
                    <a href="{% url 'member_list' %}" class="quick-action-card">
                        <div class="icon-wrapper bg-warning-soft">
                            <i class="fas fa-users text-warning"></i>
                        </div>
                        <span>All Members</span>
                    </a>
                </div>
                <div class="col">
                    <a href="{% url 'member_attendance' %}" class="quick-action-card">
                        <div class="icon-wrapper bg-purple-soft">
                            <i class="fas fa-clipboard-check text-purple"></i>
                        </div>
                        <span>Attendance</span>
                    </a>
                </div>
                <div class="col">
                    <a href="{% url 'trainer_list' %}" class="quick-action-card">
                        <div class="icon-wrapper bg-teal-soft">
                            <i class="fas fa-user-tie text-teal"></i>
                        </div>
                        <span>Trainers</span>
                    </a>
                </div>
                <div class="col">
                    <a href="{% url 'workout_plans' %}" class="quick-action-card">
                        <div class="icon-wrapper bg-orange-soft">
                            <i class="fas fa-dumbbell text-orange"></i>
                        </div>
                        <span>Workout Plans</span>
                    </a>
                </div>
            </div>
        </div>



        <!-- MEMBER GROWTH CHART -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 font-weight-bold">Member Growth</h5>
                <small>Last 6 Months</small>
            </div>
            <div class="card-body">
                <canvas id="member-growth-chart" style="height: 300px;"></canvas>
            </div>
        </div>

        <!-- ATTENDANCE + CLASSES -->
        <div class="row">
            <div class="col-xl-8 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body overflow-auto">
                        <h5 class="mb-3">Today's Attendance ({{ today_attendance_count }} Members)</h5>
                        <table class="table">
                            <thead class="thead-light">
                                <tr>
                                    <th>Member</th>
                                    <th>Check-in Time</th>
                                    <th>Plan</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attendance in todays_attendance %}
                                <tr>
                                    <td>{{ attendance.member.first_name }} {{ attendance.member.last_name }}</td>
                                    <td>{{ attendance.check_in_time|time:"g:i A" }}</td>
                                    <td><span class="badge badge-info">{{ attendance.member.latest_membership.plan.title|default:"No Plan" }}</span></td>
                                    <td>
                                        {% if attendance.member.is_active %}
                                            <span class="badge badge-success">Active</span>
                                        {% else %}
                                            <span class="badge badge-danger">Expired</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No attendance recorded today</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if todays_attendance %}
                        <a href="#" class="text-primary font-weight-bold">View all attendance</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-xl-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="mb-3">Today's Attendance Overview</h5>
                        <div class="chart-container my-auto">
                            <canvas id="attendance-chart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="row">
                                <div class="col-6">
                                    <div class="bg-success text-white p-2 rounded">
                                        <h5 class="mb-0">{{ present_count }}</h5>
                                        <small>Present</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="bg-warning text-white p-2 rounded">
                                        <h5 class="mb-0">{{ absent_count }}</h5>
                                        <small>Expected</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEMBERSHIP EXPIRIES SECTION -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0 font-weight-bold">Membership Expiries</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Expired Members Table -->
                    <div class="col-md-6">
                        <div class="card border-danger mb-4">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0 font-weight-bold">Expired ({{ expired_members|length }})</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Member</th>
                                                <th>Plan</th>
                                                <th>Expiry Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for member in expired_members %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>
                                                    <div>
                                                         <strong> <a href="{% url 'member_profile' member.id %}" class="text-decoration-none">{{ member.name }}</a></strong><br>
                                                        <br>
                                                        <small class="text-muted">{{ member.member_id|default:"No ID" }}</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if member.latest_membership and member.latest_membership.plan %}
                                                        <span class="badge badge-secondary">{{ member.latest_membership.plan.title }}</span>
                                                    {% else %}
                                                        <span class="badge badge-light">No Plan</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if member.latest_membership %}
                                                        <span class="text-danger">{{ member.latest_membership.get_end_date|date:"d M Y" }}</span>
                                                        <br>
                                                        <small class="text-muted">
                                                            {{ member.latest_membership.get_end_date|timesince }} ago
                                                        </small>
                                                    {% else %}
                                                        <span class="text-muted">No membership</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-3">
                                                    <i class="fas fa-check-circle text-success fa-lg mb-2"></i>
                                                    <p class="mb-0">No expired memberships</p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% if expired_members %}
                            <div class="card-footer bg-light">
                                <a href="#" class="btn btn-sm btn-outline-danger">Contact Expired Members</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Upcoming Expiries Table -->
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0 font-weight-bold">Upcoming ({{ upcoming_expiries|length }})</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Member</th>
                                                <th>Plan</th>
                                                <th>Expiry Date</th>
                                                <th>Days Left</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for member in upcoming_expiries %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>
                                                    <div>
                                                         <strong> <a href="{% url 'member_profile' member.id %}" class="text-decoration-none">{{ member.first_name }} {{ member.last_name }}</a></strong><br>
                                                        <small class="text-muted">{{ member.member_id|default:"No ID" }}</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if member.latest_membership and member.latest_membership.plan %}
                                                        <span class="badge badge-info">{{ member.latest_membership.plan.title }}</span>
                                                    {% else %}
                                                        <span class="badge badge-light">No Plan</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if member.latest_membership %}
                                                        <span class="text-warning">{{ member.latest_membership.get_end_date|date:"d M Y" }}</span>
                                                    {% else %}
                                                        <span class="text-muted">No membership</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if member.latest_membership %}
                                                        {% with days_left=member.latest_membership.days_until_expiry %}
                                                            {% if days_left < 0 %}
                                                                <span class="badge badge-danger">Overdue</span>
                                                            {% elif days_left == 0 %}
                                                                <span class="badge badge-warning">Today</span>
                                                            {% elif days_left <= 7 %}
                                                                <span class="badge badge-warning">{{ days_left }} days</span>
                                                            {% else %}
                                                                <span class="badge badge-success">{{ days_left }} days</span>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center text-muted py-3">
                                                    <i class="fas fa-check-circle text-success fa-lg mb-2"></i>
                                                    <p class="mb-0">No upcoming expiries</p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% if upcoming_expiries %}
                            <div class="card-footer bg-light">
                                <a href="#" class="btn btn-sm btn-outline-warning">Send Renewal Reminders</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RECENT PAYMENTS & ENQUIRIES -->
        <div class="row">
            <!-- Recent Payments -->
            <div class="col-xl-8 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body overflow-auto">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Recent Payments</h5>
                            <span class="badge badge-success">₹ {{ total_recent_payments|intcomma }}</span>
                        </div>
                        <table class="table table-sm">
                            <thead class="thead-light">
                                <tr>
                                    <th>Member</th>
                                    <th>Amount</th>
                                    <th>Mode</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_payments %}
                                <tr>
                                    <td>{{ payment.member.first_name }} {{ payment.member.last_name }}</td>
                                    <td><strong>₹ {{ payment.amount|intcomma }}</strong></td>
                                    <td><span class="badge badge-secondary">{{ payment.payment_mode }}</span></td>
                                    <td>{{ payment.payment_date|date:"d M Y" }}</td>
                                    <td>
                                        {% if payment.status == 'completed' %}
                                            <span class="badge badge-success">{{ payment.status }}</span>
                                        {% elif payment.status == 'pending' %}
                                            <span class="badge badge-warning">{{ payment.status }}</span>
                                        {% else %}
                                            <span class="badge badge-danger">{{ payment.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No recent payments</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if recent_payments %}
                        <a href="#" class="text-primary font-weight-bold">View all transactions</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Enquiries & Follow-ups -->
            <div class="col-xl-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Enquiries & Follow-ups</h5>
                            <span class="badge badge-info">{{ total_enquiries }}</span>
                        </div>
                        <ul class="list-unstyled">
                            {% for enquiry in recent_enquiries %}
                            <li class="mb-3 p-2 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ enquiry.name }}</strong>
                                        <div class="small text-muted">{{ enquiry.source|default:"Walk-in" }} • {{ enquiry.created_at|date:"d M" }}</div>
                                        <div class="mt-1">{{ enquiry.message|truncatechars:50 }}</div>
                                    </div>
                                    <div>
                                        {% if enquiry.status == 'new' %}
                                            <span class="badge badge-pill badge-success">New</span>
                                        {% elif enquiry.status == 'follow_up' %}
                                            <span class="badge badge-pill badge-warning">Follow-up</span>
                                        {% elif enquiry.status == 'converted' %}
                                            <span class="badge badge-pill badge-primary">Converted</span>
                                        {% else %}
                                            <span class="badge badge-pill badge-secondary">{{ enquiry.status }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-phone mr-1"></i>{{ enquiry.phone|default:"No phone" }}
                                        {% if enquiry.follow_up_date %}
                                            • <i class="fas fa-calendar ml-2 mr-1"></i>Follow-up: {{ enquiry.follow_up_date|date:"d M" }}
                                        {% endif %}
                                    </small>
                                </div>
                            </li>
                            {% empty %}
                            <li class="text-center text-muted py-3">
                                <i class="fas fa-inbox fa-lg mb-2"></i>
                                <p class="mb-0">No recent enquiries</p>
                            </li>
                            {% endfor %}
                        </ul>
                        {% if recent_enquiries %}
                        <a href="#" class="text-primary font-weight-bold">Manage all enquiries</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- QUICK ACTIONS BAR -->
        <div class="card shadow-sm mb-4">
            <div class="card-body d-flex flex-wrap align-items-center justify-content-between">
                
                <div>
                    <small class="text-muted">
                        <i class="fas fa-sync-alt mr-1"></i>Last synced: {% now "d M Y, H:i" %}
                    </small>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block javascript %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Enhanced Member Growth Chart with Dynamic Data
const ctx = document.getElementById('member-growth-chart').getContext('2d');

// Creating a gradient for the fill
const gradient = ctx.createLinearGradient(0, 0, 0, 300);
gradient.addColorStop(0, 'rgba(54, 162, 235, 0.25)');
gradient.addColorStop(1, 'rgba(54, 162, 235, 0)');

const memberGrowthChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ month_labels|safe }},
        datasets: [{
            label: 'New Members',
            data: {{ new_member_counts|safe }},
            tension: 0.3,
            fill: true,
            backgroundColor: gradient,
            borderColor: '#36A2EB',
            pointBackgroundColor: '#fff',
            pointBorderColor: '#36A2EB',
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#36A2EB',
            pointRadius: 4,
            borderWidth: 2,
        }, {
            label: 'Active Members',
            data: {{ active_member_counts|safe }},
            tension: 0.3,
            fill: false,
            borderColor: '#4BC0C0',
            pointBackgroundColor: '#fff',
            pointBorderColor: '#4BC0C0',
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#4BC0C0',
            pointRadius: 4,
            borderWidth: 2,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    font: {
                        size: 14,
                        family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif"
                    }
                }
            },
            tooltip: {
                enabled: true,
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleFont: {
                    size: 14,
                    weight: 'bold',
                },
                bodyFont: {
                    size: 13,
                },
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += context.parsed.y + ' members';
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(200, 200, 200, 0.2)',
                },
                ticks: {
                    font: {
                        size: 12,
                    },
                    callback: function(value) {
                        return value;
                    }
                },
                title: {
                    display: true,
                    text: 'Number of Members'
                }
            },
            x: {
                grid: {
                    display: false,
                },
                ticks: {
                    font: {
                        size: 12,
                    }
                }
            }
        },
        interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
        }
    }
});

// Attendance doughnut chart with dynamic data
const attendanceCtx = document.getElementById('attendance-chart').getContext('2d');
const attendanceChart = new Chart(attendanceCtx, {
    type: 'doughnut',
    data: {
        labels: ['Present', 'Expected'],
        datasets: [{
            label: 'Attendance',
            data: [{{ present_count|default:"2" }}, {{ absent_count|default:"1" }}],
            backgroundColor: [
                'rgba(9, 155, 155, 0.95)',
                'rgba(226, 168, 20, 0.87)',
            ],
            borderColor: [
                'rgba(75, 192, 192, 1)',
                'rgba(255, 206, 86, 1)',
            ],
            borderWidth: 2,
            hoverOffset: 15
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    font: {
                        size: 12
                    },
                    padding: 20
                }
            },
            tooltip: {
                enabled: true,
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = Math.round((value / total) * 100);
                        return `${label}: ${value} (${percentage}%)`;
                    }
                }
            }
        },
        cutout: '70%'
    }
});

// Send renewal reminders functionality
document.getElementById('sendRemindersBtn')?.addEventListener('click', function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
    btn.disabled = true;
    
    // Simulate API call
    setTimeout(function() {
        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Reminders Sent!';
        btn.classList.remove('btn-outline-warning');
        btn.classList.add('btn-success');
        
        // Reset button after 3 seconds
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-warning');
            btn.disabled = false;
        }, 3000);
    }, 1500);
});

// Auto-refresh data every 5 minutes
setTimeout(function() {
    location.reload();
}, 300000); // 5 minutes

// Add hover effects to table rows
document.addEventListener('DOMContentLoaded', function() {
    const tableRows = document.querySelectorAll('table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});
</script>

<style>
/* Additional Custom Styles */
.card {
    border: 1px solid rgba(0, 0, 0, 0.075);
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.075);
}

.badge {
    font-weight: 500;
    font-size: 0.8em;
}

.table th {
    font-weight: 600;
    font-size: 0.9em;
    text-transform: uppercase;
    color: #6c757d;
    border-top: none;
}

.table td {
    vertical-align: middle;
}

.card.border-danger {
    border-width: 2px;
}

.card.border-warning {
    border-width: 2px;
}

.btn-block {
    padding: 0.75rem 0;
    font-weight: 500;
}

.chart-container {
    position: relative;
    height: 200px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .page-header > div:last-child {
        margin-top: 1rem;
    }
    
    .btn-block {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}